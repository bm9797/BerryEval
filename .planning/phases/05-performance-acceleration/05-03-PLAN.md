---
phase: 05-performance-acceleration
plan: 03
type: execute
wave: 2
depends_on:
  - 05-01
files_modified:
  - .github/workflows/ci.yml
  - .github/workflows/wheels.yml
  - pyproject.toml
autonomous: true
requirements:
  - PERF-01
  - PERF-02

must_haves:
  truths:
    - "CI test job compiles C extension and runs tests with native backend on all 3 platforms"
    - "Binary wheels are built for Linux (manylinux x86_64), macOS (Intel + ARM), and Windows (x86_64)"
    - "Pure Python sdist is also built as fallback for unsupported platforms"
    - "Wheel build workflow triggers on tagged releases and can be run manually"
    - "Users on supported platforms get pre-built binary wheels from PyPI (no compiler needed)"
  artifacts:
    - path: ".github/workflows/ci.yml"
      provides: "Updated CI pipeline that compiles and tests C extension"
      contains: "pip install -e"
    - path: ".github/workflows/wheels.yml"
      provides: "cibuildwheel workflow for binary wheel distribution"
      contains: "cibuildwheel"
    - path: "pyproject.toml"
      provides: "cibuildwheel configuration section"
      contains: "tool.cibuildwheel"
  key_links:
    - from: ".github/workflows/wheels.yml"
      to: "pyproject.toml"
      via: "cibuildwheel reads [tool.cibuildwheel] config"
      pattern: "tool\\.cibuildwheel"
    - from: ".github/workflows/ci.yml"
      to: "setup.py"
      via: "pip install -e . triggers Extension() compilation"
      pattern: "pip install"
    - from: ".github/workflows/wheels.yml"
      to: "setup.py"
      via: "cibuildwheel invokes setuptools to compile extension for each platform"
      pattern: "cibuildwheel"
---

<objective>
Update CI to compile and test the C extension, and add a cibuildwheel workflow for building binary wheels across Linux, macOS, and Windows.

Purpose: Ensure all platforms receive pre-built binary wheels so users do not need a C compiler to install BerryEval with native acceleration. CI validates the extension compiles and passes tests on all supported platforms.
Output: Updated ci.yml with C compilation in test matrix, new wheels.yml for release wheel builds, cibuildwheel config in pyproject.toml.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-performance-acceleration/05-CONTEXT.md
@.planning/phases/05-performance-acceleration/05-01-SUMMARY.md
@.github/workflows/ci.yml
@pyproject.toml
@setup.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update CI to compile and test C extension</name>
  <files>
    .github/workflows/ci.yml
  </files>
  <action>
**Update .github/workflows/ci.yml:**

The existing CI already runs `pip install -e ".[dev]"` which, after Plan 05-01 adds setup.py with Extension(), will automatically compile the C extension. The key changes are:

1. **Verify native backend is active in test job.** Add a step after install that confirms the C extension loaded:
```yaml
- name: Verify C extension
  run: python -c "from berryeval.metrics import get_backend; assert get_backend() == 'native', f'Expected native backend, got {get_backend()}'"
```

2. **Ensure the test job has build tools.** On ubuntu-latest and macos-latest, gcc/clang are pre-installed. On windows-latest, MSVC is available via setup-python. No additional setup needed — setuptools handles compiler detection.

3. **Add a pure-Python fallback test.** Add a separate job (or matrix entry) that tests WITHOUT the C extension to confirm the fallback path still works. The simplest approach: add a job that installs from sdist (which may not compile C on all setups) or explicitly tests Python backend:

```yaml
  test-python-fallback:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"
      - name: Install without C extension
        run: |
          # Install deps manually without building extension
          pip install numpy>=2.0 typer[all]>=0.15.0 rich>=13.9.0 openai>=1.60.0 pydantic>=2.0 pyyaml>=6.0
          pip install ruff>=0.9.0 mypy>=1.14.0 pytest>=8.0 pytest-cov>=6.0
          # Install package without extension by setting env var
          BERRYEVAL_NO_NATIVE=1 pip install --no-build-isolation -e ".[dev]"
        env:
          BERRYEVAL_NO_NATIVE: "1"
      - name: Verify Python fallback
        run: python -c "from berryeval.metrics import get_backend; assert get_backend() == 'python', f'Expected python backend, got {get_backend()}'"
      - name: Run tests with Python backend
        run: pytest --cov=berryeval --cov-report=xml -v
```

However, the above requires modifying setup.py to respect BERRYEVAL_NO_NATIVE. A simpler approach: just rename _native.so before testing to force fallback:

```yaml
  test-python-fallback:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"
      - run: pip install -e ".[dev]"
      - name: Disable C extension for fallback test
        run: |
          # Find and rename the compiled .so to simulate missing extension
          find berryeval/ -name "_native*.so" -exec mv {} {}.disabled \;
          find berryeval/ -name "_native*.pyd" -exec mv {} {}.disabled \;
      - name: Verify Python fallback
        run: python -c "from berryeval.metrics import get_backend; assert get_backend() == 'python'"
      - name: Run tests with Python backend
        run: pytest -v
```

**Full updated ci.yml:**

```yaml
name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"
      - run: pip install -e ".[dev]"
      - run: ruff check .
      - run: ruff format --check .

  typecheck:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"
      - run: pip install -e ".[dev]"
      - run: mypy berryeval

  test:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        python-version: ["3.10", "3.11", "3.12"]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: "pip"
      - run: pip install -e ".[dev]"
      - name: Verify C extension compiled
        run: python -c "from berryeval.metrics import get_backend; assert get_backend() == 'native', f'Expected native, got {get_backend()}'"
      - run: pytest --cov=berryeval --cov-report=xml -v

  test-python-fallback:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"
      - run: pip install -e ".[dev]"
      - name: Disable C extension
        run: find berryeval/ -name "_native*.so" -exec mv {} {}.disabled \;
      - name: Verify Python fallback active
        run: python -c "from berryeval.metrics import get_backend; assert get_backend() == 'python'"
      - name: Run tests with Python backend
        run: pytest -v
```
  </action>
  <verify>
cd /Users/benjaminmarks/Desktop/BerryEval && python -c "import yaml; yaml.safe_load(open('.github/workflows/ci.yml'))" 2>/dev/null || python -c "
# Validate YAML syntax
with open('.github/workflows/ci.yml') as f:
    content = f.read()
print('ci.yml length:', len(content), 'bytes')
assert 'get_backend' in content, 'Missing backend verification step'
assert 'test-python-fallback' in content, 'Missing fallback test job'
assert 'native' in content, 'Missing native backend check'
print('ci.yml validation passed')
"
  </verify>
  <done>
CI test job verifies C extension compiles and reports native backend on all 3 OS x 3 Python version matrix. Separate fallback test job confirms pure Python mode still works when extension is unavailable. YAML is valid and all jobs are properly defined.
  </done>
</task>

<task type="auto">
  <name>Task 2: cibuildwheel configuration and release workflow</name>
  <files>
    pyproject.toml
    .github/workflows/wheels.yml
  </files>
  <action>
**pyproject.toml additions:**

Add cibuildwheel configuration section at the end of pyproject.toml:

```toml
[tool.cibuildwheel]
# Build for CPython only (no PyPy)
build = "cp310-* cp311-* cp312-*"
# Skip 32-bit builds and musllinux (reduces build time, covers >99% of users)
skip = "*-win32 *-manylinux_i686 *-musllinux_*"

# Test the built wheel
test-requires = ["pytest>=8.0"]
test-command = "pytest {project}/tests/metrics/ -v"

[tool.cibuildwheel.linux]
# manylinux2014 for broad compatibility
manylinux-x86_64-image = "manylinux2014"

[tool.cibuildwheel.macos]
# Build universal2 wheels (Intel + ARM in one wheel)
archs = ["x86_64", "arm64"]

[tool.cibuildwheel.windows]
archs = ["AMD64"]
```

**Important:** Do NOT add cibuildwheel to dev dependencies — it runs in CI only and installs itself in the workflow.

**.github/workflows/wheels.yml:**

Create a new workflow for building and publishing binary wheels:

```yaml
name: Build Wheels

on:
  # Build wheels on tagged releases
  push:
    tags:
      - "v*"
  # Allow manual trigger for testing
  workflow_dispatch:

jobs:
  build-wheels:
    name: Build wheels on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install cibuildwheel
        run: pip install cibuildwheel==2.22.0

      - name: Build wheels
        run: cibuildwheel --output-dir wheelhouse

      - name: Upload wheels
        uses: actions/upload-artifact@v4
        with:
          name: wheels-${{ matrix.os }}
          path: wheelhouse/*.whl

  build-sdist:
    name: Build source distribution
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install build
        run: pip install build

      - name: Build sdist
        run: python -m build --sdist

      - name: Upload sdist
        uses: actions/upload-artifact@v4
        with:
          name: sdist
          path: dist/*.tar.gz

  publish:
    name: Publish to PyPI
    needs: [build-wheels, build-sdist]
    runs-on: ubuntu-latest
    # Only publish on tagged releases, not manual triggers
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
    permissions:
      id-token: write  # Required for trusted publishing
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist
          merge-multiple: true

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          # Uses trusted publishing (OIDC) — no API token needed
          # Requires PyPI project to be configured for trusted publishing
          packages-dir: dist/
```

Notes:
- cibuildwheel version pinned to 2.22.0 for reproducibility (latest stable as of early 2026)
- Trusted publishing via OIDC (no API tokens stored in secrets) — requires one-time PyPI setup
- sdist built separately as pure Python fallback for platforms without binary wheel
- Manual dispatch allows testing the wheel build without creating a release tag
- The test-command in cibuildwheel config runs metric tests inside the built wheel to verify the extension works on each platform
  </action>
  <verify>
cd /Users/benjaminmarks/Desktop/BerryEval && python -c "
# Validate wheels.yml exists and has correct structure
with open('.github/workflows/wheels.yml') as f:
    content = f.read()
assert 'cibuildwheel' in content, 'Missing cibuildwheel'
assert 'build-sdist' in content, 'Missing sdist job'
assert 'ubuntu-latest' in content and 'macos-latest' in content and 'windows-latest' in content, 'Missing OS matrix'
print('wheels.yml validation passed')

# Validate pyproject.toml has cibuildwheel config
with open('pyproject.toml') as f:
    content = f.read()
assert 'tool.cibuildwheel' in content, 'Missing cibuildwheel config'
assert 'cp310' in content, 'Missing Python version targets'
print('pyproject.toml cibuildwheel config present')
print('All validations passed')
"
  </verify>
  <done>
wheels.yml workflow builds binary wheels via cibuildwheel for Linux (manylinux x86_64), macOS (Intel + ARM), and Windows (AMD64) across Python 3.10-3.12. Pure Python sdist built as fallback. Publish job uploads to PyPI via trusted publishing on tagged releases. pyproject.toml contains cibuildwheel configuration. CI workflow validates C extension on all platforms.
  </done>
</task>

</tasks>

<verification>
```bash
# Validate YAML files parse correctly
cd /Users/benjaminmarks/Desktop/BerryEval && python -c "
import yaml
for f in ['.github/workflows/ci.yml', '.github/workflows/wheels.yml']:
    with open(f) as fh:
        yaml.safe_load(fh)
    print(f'{f}: valid YAML')
"

# Verify pyproject.toml has cibuildwheel section
python -c "
try:
    import tomllib
except ImportError:
    import tomli as tomllib
with open('pyproject.toml', 'rb') as f:
    config = tomllib.load(f)
assert 'cibuildwheel' in config.get('tool', {}), 'Missing cibuildwheel config'
print('pyproject.toml: cibuildwheel config present')
"

# Full test suite still passes
python -m pytest tests/ -v

# Existing CI still works (C extension + tests)
pip install -e ".[dev]" && python -c "from berryeval.metrics import get_backend; print(get_backend())"
```
</verification>

<success_criteria>
- ci.yml verifies C extension compiled on all OS x Python matrix entries
- ci.yml includes fallback test confirming pure Python mode works
- wheels.yml builds binary wheels for Linux, macOS (Intel + ARM), Windows
- wheels.yml builds pure Python sdist as fallback
- wheels.yml publishes to PyPI on tagged releases via trusted publishing
- pyproject.toml has cibuildwheel config targeting CPython 3.10-3.12
- All existing tests still pass
</success_criteria>

<output>
After completion, create `.planning/phases/05-performance-acceleration/05-03-SUMMARY.md`
</output>
